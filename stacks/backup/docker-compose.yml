services:
  backup:
    image: ghcr.io/tianshanghong/docker-volume-backup:latest
    container_name: backup
    restart: unless-stopped
    environment:
      BACKUP_CRON_EXPRESSION: "0 2 * * *"
      BACKUP_FILENAME: "backup-%Y-%m-%dT%H-%M-%S.tar.gz"
      AWS_S3_BUCKET_NAME: ${BACKUP_S3_BUCKET}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      AWS_ENDPOINT: ${BACKUP_AWS_ENDPOINT:-}
      AWS_S3_PATH: ${BACKUP_S3_PATH:-vol}
      # Backup encryption (mutually exclusive — only one may be set).
      # Strongly recommended: backups include .env (secrets).
      # See docs/BACKUP_ENCRYPTION.md for details.
      GPG_PASSPHRASE: ${GPG_PASSPHRASE:-}
      AGE_PASSPHRASE: ${AGE_PASSPHRASE:-}
      AGE_PUBLIC_KEYS: ${AGE_PUBLIC_KEYS:-}
      # GPG asymmetric — uncomment below AND the matching volume mount:
      # GPG_PUBLIC_KEY_RING_FILE: /keys/public_key.asc
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /opt/stacks/.env:/backup/dotenv/.env:ro
      # GPG asymmetric key file (uncomment with GPG_PUBLIC_KEY_RING_FILE above):
      # - /opt/stacks/gpg-public-key.asc:/keys/public_key.asc:ro
      # Mount volumes you want to back up under /backup/:
      #   - my_data:/backup/my_data:ro
      # See README for the full pattern.
    networks:
      - egress

networks:
  egress:
    driver: bridge
